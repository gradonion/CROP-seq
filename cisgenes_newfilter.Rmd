---
title: "cis-gene analysis on CROP-seq data"
author: "Yifan Zhou"
date: "6/25/2019"
output:   
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=9, fig.height=3, fig.path='Figs/',
  echo=TRUE, warning=FALSE, message=FALSE, comment = NA, fig.align = 'center')
```

```{r load data}
library(ggplot2)
library(knitr)
library(kableExtra)
library(gridExtra)
library(ashr)
options(stringsAsFactors = F)
wkdir <- '~/Downloads/ASoC/singlecell/'
ash_on_scttest <- function(uniq.cisgenes,option){
  for (i in 1:nrow(uniq.cisgenes)) {
    if (option=='enhancer'){
      tmp.column <- uniq.cisgenes$locus[i]
    } else if (option=='gRNA') {
      tmp.column <- uniq.cisgenes$gRNA[i]
    } else {
      print('Please provide a valid type: enhancer or gRNA.')
      return(1)
    }
    tmp.gene <- uniq.cisgenes$cisGene[i]
    uniq.cisgenes$ttest.beta[i] <- beta.mtx[tmp.gene,tmp.column]
    uniq.cisgenes$ttest.se[i] <- se.mtx[tmp.gene,tmp.column]
    uniq.cisgenes$ttest.pval[i] <- pval.mtx[tmp.gene,tmp.column]
  }
  uniq.cisgenes <- na.omit(uniq.cisgenes)
  cat(nrow(uniq.cisgenes),'data points:')
  uniq.cisgenes$zscore <- uniq.cisgenes$ttest.beta/uniq.cisgenes$ttest.se
  plot1 <- ggplot(uniq.cisgenes,aes(zscore)) + geom_histogram(aes(y=..density..),bins = 30) +
    labs(x = 'z-score from ttest',y='frequency') + 
    stat_function(fun = dnorm, args = list(mean = 0, sd = 1),col=2)
  
  ash.ttest <- ash(uniq.cisgenes$ttest.beta,uniq.cisgenes$ttest.se,mixcompdist = '-uniform')
  uniq.cisgenes$ash.beta <- ash.ttest$result$PosteriorMean
  uniq.cisgenes$lfsr <- get_lfsr(ash.ttest)
  uniq.cisgenes$lfdr <- get_lfdr(ash.ttest)
  log10_lfsr <- log10(get_lfsr(ash.ttest))
  plot2 <- qplot(uniq.cisgenes$ttest.beta, uniq.cisgenes$ash.beta,
                 color=log10_lfsr, main = 'ash shrinkage on ttest result',
                 xlab = 'log fold change', ylab = 'beta after shrinkage') + 
    geom_abline(intercept = 0,slope = 1,linetype = "dotted")
  grid.arrange(plot1,plot2,ncol=2)
  uniq.cisgenes <- uniq.cisgenes[order(uniq.cisgenes$lfsr),]
  uniq.cisgenes <- format(uniq.cisgenes,digits=3)
  print(kable(uniq.cisgenes,row.names = F) %>% kable_styling() %>%
          scroll_box(width = "100%", height = "300px"))
  ash.stats <- data.frame(pi=ash.ttest$fitted_g$pi, 
                        interval_a=ash.ttest$fitted_g$a, interval_b=ash.ttest$fitted_g$b)
  cat('ash estimated mixture proportions and corresponding intervals:')
  print(kable(ash.stats[ash.stats$pi!=0,], row.names = F, digits = 3) %>% 
          kable_styling(position = 'center',full_width = T) )
}
```

## Categorical regression on `sctransformed` data

We use the Pearson residuals obtained from `sctransform` on the raw UMI count matrix using the following command:
```
sctransform::vst(as.matrix(gene.exp),n_genes = NULL,return_gene_attr = TRUE, return_cell_attr = TRUE)
```

`sctransform` models the expression of each gene as a negative binomial random variable with a mean that depends on  the sequencing depth for each cell. The resulting Pearson residuals should have mean zero and a stable variance across the range of expression. Learn more about `sctransform` on this CROP-seq dataset [here](https://gradonion.github.io/CROP-seq/analysis_sctransform.html).

We further exclude genes that are expressed in less than 10% of all cells, and remove cells that don't have any gRNAs detected (706 out of 4414).

We have 2 ways to partition the cells for DE analysis:

1. For each enhancer target (21 in total), partition the cells into 2 groups: cells that contain any gRNAs that target the enhancer, and cells that contain none of the gRNAs that target the enhancer.

2. For each gRNA target (63 in total), partition the cells into 2 groups: cells that contain that gRNA , and cells that don't contain that gRNA.

For _cis_-gene differential expression analysis, we only need to focus on genes within $\pm$ 200kb/ 500kb/ 1 MB of the SNP loci of interest. Then for each pair of cell groups, we test for differential expression of each nearby gene of that enhancer/gRNA locus using categorical regression.

## ash on `sctransform`ed _t_-test (grouped by gRNA) result
```{r ash_on_ttest}
summary_per_gene <- readRDS(paste0(wkdir,'data/full.summary_per_gene.gRNA_grp.rds'))
beta.mtx <- sapply(summary_per_gene, function(x){x$beta})
se.mtx <- sapply(summary_per_gene, function(x){x$se})
pval.mtx <- sapply(summary_per_gene, function(x){x$pval})
load(paste0(wkdir, 'data/full.cisgenes_SNP.expanded.Rdata'))
```

### 200 kb _cis_ genes
```{r new.200kb, results='asis'}
ash_on_scttest(full_genes.200kb.expanded,'gRNA')
```

***

### 500 kb _cis_ genes
```{r new.500kb, results='asis'}
ash_on_scttest(full_genes.500kb.expanded,'gRNA')
```

***

### 1 Mb _cis_ genes
```{r new.1Mb, results='asis'}
ash_on_scttest(full_genes.1Mb.expanded,'gRNA')
```

***

## Session Information
```{r}
sessionInfo()
```


